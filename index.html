<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Bank & Recycling Finder</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Add Leaflet MarkerCluster for handling large numbers of markers -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Kaleidoscope effect -->
    <script defer src="https://cdn.jsdelivr.net/npm/three-js@79.0.0/three.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/gh/the-lazy-god/tlg-kaleidoscope@v2.0.1/tlg-kaleidoscope.min.js"></script>
    <style>
        :root {
            --primary: #34d399;
            --secondary: #0d9488;
            --accent: #06b6d4;
            --background: #f5f7fa;
            --card-bg: #ffffff;
            --text: #333333;
            --light-text: #718096;
            --border: #e2e8f0;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --error: #e74c3c;
            --food-bank: #fb923c;
            --recycling: #22c55e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', system-ui, -apple-system, sans-serif;
        }

        body { 
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
            position: relative;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 20px 0;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        .kaleidoscope-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            opacity: 0.65;
            mix-blend-mode: overlay;
        }

        .kaleidoscope-image-container {
            display: none;
        }

        .header-content {
            position: relative;
            z-index: 2;
        }

        .container {
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            padding: 0;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .app-layout {
            display: flex;
            height: calc(100vh - 150px);
            overflow: hidden;
        }

        .sidebar {
            width: 400px;
            background: var(--card-bg);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border);
            z-index: 5;
            transition: all 0.3s ease;
        }

        .main-content {
            flex: 1;
            position: relative;
        }

        .map-container {
            height: 100%;
            width: 100%;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
        }

        .header h1 {
            margin-bottom: 0.25rem;
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header .tagline {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .data-sources {
            font-size: 0.75rem;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.5rem;
        }

        .data-sources a {
            color: white;
            text-decoration: underline;
            transition: opacity 0.2s ease;
        }

        .data-sources a:hover {
            opacity: 0.8;
        }

        .divider {
            opacity: 0.7;
        }

        .creator-credit {
            font-size: 0.75rem;
            opacity: 0.9;
            margin-top: 0.3rem;
        }

        .search-box {
            padding: 1.5rem;
            background-color: var(--card-bg);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            z-index: 5;
        }

        .search-box h2 {
            margin-bottom: 1rem;
            color: var(--primary);
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .search-box .form-group {
            margin-bottom: 0;
        }

        .search-box label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text);
            font-size: 0.9rem;
        }

        .search-input-group {
            display: flex;
            gap: 0.5rem;
        }

        .search-input-group input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .search-input-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(52, 211, 153, 0.2);
        }

        .search-input-group button {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .search-input-group button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        button {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            opacity: 0.95;
        }

        button:active {
            transform: translateY(0);
        }

        .results {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .results h2 {
            margin: 0;
            padding: 1rem 1.5rem;
            color: var(--primary);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: #ffffff;
            position: sticky;
            top: 0;
            z-index: 2;
        }

        .results::-webkit-scrollbar {
            width: 6px;
        }

        .results::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.03);
        }

        .results::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.15);
            border-radius: 3px;
        }

        .results::-webkit-scrollbar-thumb:hover {
            background: rgba(0,0,0,0.25);
        }

        .no-results {
            text-align: center;
            padding: 4rem 1rem;
            color: var(--light-text);
        }

        .no-results i {
            font-size: 2rem;
            color: var(--border);
            margin-bottom: 1rem;
            display: block;
        }

        .location-item {
            padding: 1rem 1.5rem;
            background: var(--card-bg);
            border-left: 3px solid var(--primary);
            border-bottom: 1px solid var(--border);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .location-item:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }

        .location-item.active {
            background-color: rgba(52, 211, 153, 0.1);
            border-left-width: 5px;
        }

        .location-item:last-child {
            margin-bottom: 0;
        }

        .location-item h3 {
            margin-bottom: 0.5rem;
            color: var(--text);
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .location-item .food-bank-icon {
            color: var(--food-bank);
        }

        .location-item .recycling-icon {
            color: var(--recycling);
        }

        .location-item p {
            margin: 0.3rem 0;
            font-size: 0.85rem;
            color: var(--light-text);
        }

        .location-item .location-distance {
            font-weight: 600;
            color: var(--primary);
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .location-item .location-type {
            display: inline-block;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 0.5rem;
            text-transform: uppercase;
        }

        .location-item .type-food-bank {
            background-color: rgba(251, 146, 60, 0.2);
            color: #c2410c;
        }

        .location-item .type-recycling {
            background-color: rgba(34, 197, 94, 0.2);
            color: #16a34a;
        }

        .marker-cluster-small {
            background-color: rgba(0, 184, 148, 0.3);
        }
        .marker-cluster-small div {
            background-color: rgba(0, 184, 148, 0.5);
        }

        .marker-cluster-medium {
            background-color: rgba(0, 184, 148, 0.4);
        }
        .marker-cluster-medium div {
            background-color: rgba(0, 184, 148, 0.6);
        }

        .marker-cluster-large {
            background-color: rgba(0, 184, 148, 0.5);
        }
        .marker-cluster-large div {
            background-color: rgba(0, 184, 148, 0.7);
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem;
            background-color: var(--card-bg);
            align-items: center;
            border-top: 1px solid var(--border);
        }

        .pagination button {
            padding: 0.5rem;
            background: var(--background);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pagination button:hover:not(:disabled) {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .pagination button:disabled {
            background-color: rgba(0, 0, 0, 0.05);
            color: rgba(0, 0, 0, 0.3);
            cursor: not-allowed;
            box-shadow: none;
        }

        .pagination .current-page {
            font-weight: 500;
            font-size: 0.8rem;
            padding: 0 0.5rem;
        }

        .loader {
            display: flex;
                justify-content: center;
            align-items: center;
            padding: 2rem;
            color: var(--primary);
            font-size: 1.5rem;
        }

        .loader i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background-color: rgba(231, 76, 60, 0.1);
            color: #c0392b;
            padding: 1rem 1.5rem;
            border-left: 3px solid #e74c3c;
            margin-bottom: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .items-list {
            margin-left: 1.2rem;
            margin-top: 0.5rem;
        }
        
        .items-list li {
            margin-bottom: 1px;
            font-size: 0.8rem;
        }
        
        .food-bank-type, .location-type {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            background-color: rgba(0, 184, 148, 0.1);
            color: var(--primary);
            margin-left: 5px;
        }

        .location-type.recycling {
            background-color: rgba(9, 132, 227, 0.1);
            color: var(--secondary);
        }

        .more-btn {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 0.8rem;
            padding: 0;
            cursor: pointer;
            margin-top: 0.3rem;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .more-btn:hover {
            text-decoration: underline;
            transform: none;
            box-shadow: none;
        }

        .form-select {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.95rem;
            background-color: white;
            transition: all 0.3s ease;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(52, 211, 153, 0.2);
        }

        .mobile-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .toggle-tooltip {
            position: absolute;
            top: -40px;
            left: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .mobile-toggle:hover .toggle-tooltip {
            opacity: 1;
        }

        @media (max-width: 992px) {
            .app-layout {
                height: calc(100vh - 120px);
            }
            
            .sidebar {
                width: 350px;
            }
            
            .location-item {
                padding: 0.8rem 1.2rem;
            }
        }

        @media (max-width: 768px) {
            .app-layout {
                position: relative;
                flex-direction: column;
                height: calc(100vh - 100px);
            }
            
            .sidebar {
                width: 100%;
                position: absolute;
                height: 100%;
                bottom: 0;
                transform: translateY(calc(100% - 155px));
                transition: transform 0.3s ease;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
                z-index: 10;
            }
            
            .sidebar.expanded {
                transform: translateY(0);
            }
            
            .mobile-toggle {
                display: flex;
            }
            
            .main-content {
                height: 100%;
            }
            
            .header {
                padding: 15px 0 10px;
            }
            
            .header h1 {
                font-size: 1.4rem;
            }
            
            .data-sources {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .app-layout {
                height: calc(100vh - 80px);
            }
            
            .header {
                padding: 10px 0;
            }
            
            .header h1 {
                font-size: 1.2rem;
            }
            
            .header .tagline {
                font-size: 0.8rem;
            }
            
            .creator-credit {
                display: none;
            }
            
            .sidebar {
                transform: translateY(calc(100% - 140px));
            }
            
            .search-box {
                padding: 1rem;
            }
            
            .search-box h2 {
                font-size: 1rem;
            }
            
            .form-group {
                margin-bottom: 0.5rem;
            }
            
            .form-select {
                padding: 8px 10px;
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <!-- Kaleidoscope effect -->
        <div class="kaleidoscope-wrapper" tlg-kaleidoscope-canvas tlg-kaleidoscope-mode="mouse" tlg-kaleidoscope-segments="12" tlg-kaleidoscope-scale="1.5" tlg-kaleidoscope-motion="1.2">
            <div class="kaleidoscope-image-container">
                <!-- Source images (hidden) for the kaleidoscope effect -->
                <img tlg-kaleidoscope-image src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MDAiIGhlaWdodD0iNTAwIj48cmVjdCB4PSIwIiB5PSIwIiB3aWR0aD0iNTAwIiBoZWlnaHQ9IjUwMCIgZmlsbD0iIzM0ZDM5OSIvPjxjaXJjbGUgY3g9IjI1MCIgY3k9IjI1MCIgcj0iMTUwIiBmaWxsPSIjMDA5OTllIi8+PHJlY3QgeD0iMTAwIiB5PSIxMDAiIHdpZHRoPSIzMDAiIGhlaWdodD0iMzAwIiBmaWxsPSIjNDE5YWZmIiBvcGFjaXR5PSIwLjUiLz48L3N2Zz4=" alt="Kaleidoscope source 1">
                <img tlg-kaleidoscope-image src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MDAiIGhlaWdodD0iNTAwIj48cmVjdCB4PSIwIiB5PSIwIiB3aWR0aD0iNTAwIiBoZWlnaHQ9IjUwMCIgZmlsbD0iI2Y1ZjdmYSIvPjxjaXJjbGUgY3g9IjI1MCIgY3k9IjI1MCIgcj0iMjAwIiBmaWxsPSIjMDBiODk0IiBvcGFjaXR5PSIwLjciLz48cG9seWdvbiBwb2ludHM9IjI1MCwxMDAgNDAwLDQwMCAxMDAsNDAwIiBmaWxsPSIjMDk4NGUzIiBvcGFjaXR5PSIwLjUiLz48L3N2Zz4=" alt="Kaleidoscope source 2">
            </div>
        </div>

        <!-- Header content -->
        <div class="container header-content">
            <h1><i class="fas fa-hands-helping"></i> Food Bank & Recycling Finder</h1>
            <p class="tagline">Find food banks and recycling centers near you</p>
            <div class="data-sources">
                <span><i class="fas fa-shopping-basket"></i> Food bank data from <a href="https://gist.github.com/4t0m15/ed9c9b8608e1b07f7bdd96b938b7f90b" target="_blank">GitHub Gist</a></span>
                <span class="divider">|</span>
                <span>Powered by <a href="https://github.com/whatfoodbanksneed/food_bank_api" target="_blank">This Dead API (which I recycled)</a></span>
                <span class="divider">|</span>
                <span><i class="fas fa-recycle"></i> Recycling data from <a href="https://www.openstreetmap.org" target="_blank">OpenStreetMap</a></span>
                <span class="divider">|</span>
                <span><i class="fas fa-icons"></i> Icons by <a href="https://fontawesome.com" target="_blank">Font Awesome</a></span>
            </div>
            <div class="creator-credit">
                <i class="fas fa-heart" style="color: #e74c3c;"></i> Created by Arsen Marirosyan and Alim Apekov for the Hackabyte Spring Hackathon
            </div>
        </div>
    </div>

    <div class="container">
        <div class="app-layout">
            <div class="sidebar">
        <div class="search-box">
                    <h2><i class="fas fa-search"></i> Find Locations</h2>
                    <div class="form-group">
                        <label for="zipCode">Enter a location</label>
                        <div class="search-input-group">
                            <input type="text" id="zipCode" placeholder="e.g. London, Manchester, Mumbai, Yerevan, Moscow, Timbuktu, etc." />
                            <button onclick="findRecyclingCenters()"><i class="fas fa-search"></i></button>
        </div>
                    </div>
                    <div class="form-group" style="margin-top: 10px;">
                        <label for="locationType">Filter by Location Type</label>
                        <select id="locationType" class="form-select" onchange="filterResults()">
                            <option value="all">Show All Locations</option>
                            <option value="food_bank">Food Banks Only</option>
                            <option value="recycling">Recycling Centers Only</option>
                        </select>
                    </div>
                </div>
            <div class="results" id="results">
                    <div class="no-results">
                        <i class="fas fa-map-marked-alt"></i>
                        <p>Enter a location above to find food banks and recycling centers near you.</p>
                    </div>
                </div>
                <div id="data-status" style="padding: 10px; background-color: rgba(0,0,0,0.05); font-size: 12px; color: #666; border-top: 1px solid #eee; display: none;">
                    <p><strong>Data Sources:</strong></p>
                    <p id="food-bank-status"><i class="fas fa-spinner fa-spin"></i> Food Banks: Loading...</p>
                    <p id="recycling-status"><i class="fas fa-spinner fa-spin"></i> Recycling Centers: Not queried yet</p>
                </div>
            </div>
            <div class="main-content">
                <div class="map-container">
                    <div id="map"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        var map = L.map('map').setView([51.505, -0.09], 13);
        var foodBankData = {};
        var recyclingCentersData = {};  // Initialize as empty object instead of null
        var foodBankLocationsFound = [];
        var recyclingCentersFound = [];
        var markerCluster = L.markerClusterGroup({
            chunkedLoading: true,
            zoomToBoundsOnClick: true,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false
        });
        var markers = [];
        var currentSearchType = 'all';
        var displayedLocations = []; // To store the currently displayed locations

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Add the marker cluster to the map
        map.addLayer(markerCluster);

        // Initialize kaleidoscope effect
        document.addEventListener('DOMContentLoaded', function() {
            function initKaleidoscope() {
                const canvas = document.createElement('canvas');
                const wrapper = document.querySelector('[tlg-kaleidoscope-canvas]');
                
                if (!wrapper) return;
                
                const mode = wrapper.getAttribute('tlg-kaleidoscope-mode') || 'mouse';
                const segments = parseInt(wrapper.getAttribute('tlg-kaleidoscope-segments') || 12);
                const scale = parseFloat(wrapper.getAttribute('tlg-kaleidoscope-scale') || 1);
                const motion = parseFloat(wrapper.getAttribute('tlg-kaleidoscope-motion') || 1);
                
                // Setup canvas
                canvas.width = window.innerWidth;
                canvas.height = wrapper.offsetHeight;
                canvas.style.position = 'absolute';
                canvas.style.top = '0';
                canvas.style.left = '0';
                canvas.style.width = '100%';
                canvas.style.height = '100%';
                
                wrapper.appendChild(canvas);
                
                const ctx = canvas.getContext('2d');
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const radius = Math.max(canvas.width, canvas.height) / 2 * scale;
                
                // Load images
                const images = Array.from(document.querySelectorAll('[tlg-kaleidoscope-image]'));
                const loadedImages = [];
                
                let imagePromises = images.map(img => {
                    return new Promise((resolve) => {
                        if (img.complete) {
                            loadedImages.push(img);
                            resolve();
                        } else {
                            img.onload = () => {
                                loadedImages.push(img);
                                resolve();
                            };
                            img.onerror = () => resolve(); // Continue even if image fails
                        }
                    });
                });
                
                // Animation variables
                let mouseX = centerX;
                let mouseY = centerY;
                let animationFrame;
                let currentImageIndex = 0;
                
                // Handle mouse movement
                if (mode === 'mouse') {
                    document.addEventListener('mousemove', (e) => {
                        mouseX = e.clientX;
                        mouseY = e.clientY;
                    });
                }
                
                // Main drawing function
                function draw() {
                    if (loadedImages.length === 0) return;
                    
                    // Auto motion if not in mouse mode
                    if (mode !== 'mouse') {
                        mouseX = centerX + Math.sin(Date.now() * 0.001 * motion) * centerX * 0.5;
                        mouseY = centerY + Math.cos(Date.now() * 0.0015 * motion) * centerY * 0.5;
                    }
                    
                    // Clear canvas
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // Save context
                    ctx.save();
                    
                    // Move to center
                    ctx.translate(centerX, centerY);
                    
                    // Calculate triangle coordinates
                    const segmentAngle = (Math.PI * 2) / segments;
                    
                    // Create clipping region for triangle
                    ctx.beginPath();
                    ctx.moveTo(0, 0);
                    ctx.lineTo(radius * Math.cos(0), radius * Math.sin(0));
                    ctx.lineTo(radius * Math.cos(segmentAngle), radius * Math.sin(segmentAngle));
                    ctx.closePath();
                    ctx.clip();
                    
                    // Calculate position relative to center
                    const relX = mouseX - centerX;
                    const relY = mouseY - centerY;
                    
                    // Draw the image in the triangle
                    const currentImage = loadedImages[currentImageIndex];
                    ctx.drawImage(
                        currentImage,
                        -relX - currentImage.width / 2,
                        -relY - currentImage.height / 2
                    );
                    
                    // Restore context to remove clipping
                    ctx.restore();
                    
                    // Draw reflections for all segments
                    for (let i = 0; i < segments; i++) {
                        ctx.save();
                        ctx.translate(centerX, centerY);
                        
                        // Rotate to segment position
                        ctx.rotate(i * segmentAngle);
                        
                        // Alternate between original and mirrored segments
                        if (i % 2 !== 0) {
                            ctx.scale(-1, 1);
                        }
                        
                        // Create clipping region for triangle
                        ctx.beginPath();
                        ctx.moveTo(0, 0);
                        ctx.lineTo(radius * Math.cos(0), radius * Math.sin(0));
                        ctx.lineTo(radius * Math.cos(segmentAngle), radius * Math.sin(segmentAngle));
                        ctx.closePath();
                        ctx.clip();
                        
                        // Draw the image in the triangle
                        ctx.drawImage(
                            currentImage,
                            -relX - currentImage.width / 2,
                            -relY - currentImage.height / 2
                        );
                        
                        ctx.restore();
                    }
                    
                    // Switch image every 5 seconds
                    if (Date.now() % 5000 < 50 && loadedImages.length > 1) {
                        currentImageIndex = (currentImageIndex + 1) % loadedImages.length;
                    }
                    
                    animationFrame = requestAnimationFrame(draw);
                }
                
                // Start animation once images are loaded
                Promise.all(imagePromises).then(() => {
                    // Hide the original images
                    images.forEach(img => {
                        img.style.display = 'none';
                    });
                    
                    // Start animation
                    draw();
                });
                
                // Handle resize
                window.addEventListener('resize', () => {
                    canvas.width = window.innerWidth;
                    canvas.height = wrapper.offsetHeight;
                });
                
                // Cleanup on page exit
                window.addEventListener('beforeunload', () => {
                    cancelAnimationFrame(animationFrame);
                });
            }
            
            // Initialize the map
            initMap();
            
            // Initialize kaleidoscope effect
            initKaleidoscope();
            
            // Load food bank data
            loadFoodBankData();
            
            // Add event listener for Enter key
            document.getElementById('zipCode').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') findRecyclingCenters();
            });
        });

        // Initialize map
        function initMap() {
            if (map) map.remove();
            map = L.map('map').setView([54.0, -2.0], 6); // Center on UK initially
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            // Re-add marker cluster after map initialization
            markerCluster = L.markerClusterGroup({
                chunkedLoading: true,
                zoomToBoundsOnClick: true,
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: false
            });
            map.addLayer(markerCluster);
            
            // Get the user's location if possible 
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    map.setView([lat, lng], 13);
                    
                    // Automatically search for locations near the user
                    const userLocation = {
                        lat: lat,
                        lon: lng,
                        displayName: "Your Current Location"
                    };
                    
                    // Add user location marker
                    const userMarker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'user-location-marker',
                            html: '<i class="fas fa-map-marker-alt" style="color: #3b82f6; font-size: 24px; text-shadow: 0 0 3px white;"></i>',
                            iconSize: [24, 24],
                            iconAnchor: [12, 24]
                        })
                    })
                    .addTo(map)
                    .bindPopup(`<b>Your Current Location</b>`);
                    
                    markers.push(userMarker);
                    
                    // Find nearby food banks and recycling centers
                    findFoodBanksNear(userLocation);
                    findRecyclingCentersNear(userLocation);
                    
                }, function() {
                    // Default view if geolocation fails (centered on London, UK)
                    map.setView([51.505, -0.09], 13);
                });
            }
        }

        // Calculate distance between two points using the Haversine formula
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the Earth in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a =
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; // Distance in km
        }

        // Extract recycling materials from tags
        function getRecyclingMaterials(tags) {
            const materials = [];
            for (const key in tags) {
                if (key.startsWith('recycling:') && tags[key] === 'yes') {
                    materials.push(key.substring(10));
                }
            }
            return materials;
        }

        // Clear all markers from the map
        function clearMarkers() {
            markerCluster.clearLayers();
            markers.forEach(marker => {
                if (marker instanceof L.MarkerClusterGroup) {
                    marker.clearLayers();
                } else if (map.hasLayer(marker)) {
                    map.removeLayer(marker);
                }
            });
            markers = [];
        }

        // Load food bank data from JSON file
        function loadFoodBankData() {
            // Show loading message
            document.getElementById("results").innerHTML = '<div class="loader"><i class="fas fa-spinner"></i><span>Loading food bank data...</span></div>';
            
            // Show data status section
            document.getElementById("data-status").style.display = "block";
            document.getElementById("food-bank-status").innerHTML = '<i class="fas fa-spinner fa-spin"></i> Food Banks: Loading from GitHub Gist...';
            
            // Define the fallback data in case everything fails
            const fallbackData = {
                "London Colney - Temporary": {
                    "address": "Caledon Community Centre, Caledon Rd, London Colney, St Albans AL2 1PU",
                    "latitude": "51.7228722",
                    "longitude": "-0.2996495",
                    "website": "http://stalbansdistrict.foodbank.org.uk/",
                    "items_needed": [
                        "Pasta",
                        "Milk (long life)",
                        "Fruit Juice (long life)",
                        "Instant Mash/Tinned Potatoes",
                        "Tinned Soup",
                        "Dried Noodles",
                        "Jam & Spreads"
                    ],
                    "location_type": "food_bank_centre",
                    "parent_food_bank": "St Albans and District Foodbank"
                },
                "Mowbray Community Church, Harrogate": {
                    "address": "1 Westmoreland St, Harrogate HG1 5AY, UK",
                    "latitude": "53.99702063265868",
                    "longitude": "-1.5303109043686618",
                    "website": "http://harrogatedistrict.foodbank.org.uk/",
                    "items_needed": [
                        "Long Life Fruit Juice",
                        "Long Life Milk",
                        "Pasta Sauce",
                        "Chocolate",
                        "Sponge Puddings"
                    ],
                    "location_type": "food_bank_centre",
                    "parent_food_bank": "Harrogate District Foodbank"
                }
            };
            
            // Fetch from the GitHub Gist instead of local file
            fetch('https://gist.githubusercontent.com/4t0m15/ed9c9b8608e1b07f7bdd96b938b7f90b/raw', {
                mode: 'cors',
                headers: {
                    'Accept': 'application/json'
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Failed to load data: ${response.status} ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Store the data
                    foodBankData = data;
                    
                    // Check if data is empty or invalid
                    if (!foodBankData || Object.keys(foodBankData).length === 0) {
                        console.warn("Loaded data was empty, using fallback data");
                        foodBankData = fallbackData;
                    }
                    
                    // Normalize the data format
                    normalizeData();
                    
                    // Update UI with the correct count of loaded food banks
                    updateInitialUI();
                    
                    // Update status
                    document.getElementById("food-bank-status").innerHTML = '<i class="fas fa-check" style="color: green;"></i> Food Banks: Loaded ' + Object.keys(foodBankData).length + ' locations from GitHub Gist';
                    
                    console.log("Food bank data loaded successfully", Object.keys(foodBankData).length, "locations");
                })
                .catch(error => {
                    console.error("Error loading food bank data:", error);
                    document.getElementById("results").innerHTML = `
                        <div class="error-message">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>Error loading food bank data: ${error.message}</span>
                        </div>
                        <div class="no-results">
                            <i class="fas fa-map-marked-alt"></i>
                            <p>Enter a location above to find recycling centers near you.</p>
                            <p style="margin-top: 15px;"><strong>But don't worry!</strong> You can still search for recycling centers even without food bank data.</p>
                            <button id="retry-load-btn" style="margin-top: 15px;">Try Loading Food Bank Data Again</button>
                        </div>
                    `;
                    
                    // Fall back to sample data
                    foodBankData = fallbackData;
                    normalizeData();
                    
                    // Add event listener for retry button
                    document.getElementById('retry-load-btn').addEventListener('click', loadFoodBankData);
                    
                    // Update status
                    document.getElementById("food-bank-status").innerHTML = '<i class="fas fa-exclamation-triangle" style="color: orange;"></i> Food Banks: Using fallback data (' + Object.keys(foodBankData).length + ' locations)';
                    
                    // Update UI with fallback data
                    updateInitialUI();
                });
        }
        
        // Update the initial UI with the food bank count
        function updateInitialUI() {
                    document.getElementById("results").innerHTML = `
                <div class="no-results">
                    <i class="fas fa-map-marked-alt"></i>
                    <p>Enter a location above to find food banks and recycling centers near you.</p>
                    <p style="margin-top: 10px;">Database loaded with <strong>${Object.keys(foodBankData).length}</strong> food bank locations.</p>
                        </div>
                    `;
        }

        // Geocode location using Nominatim
        function geocodeLocation(location) {
            return new Promise((resolve, reject) => {
                const nominatimUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(location)}&format=json&limit=1`;

                fetch(nominatimUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Network error: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (!data || !data.length) {
                            throw new Error("Location not found");
                        }

                        const userLocation = {
                            lat: parseFloat(data[0].lat),
                            lon: parseFloat(data[0].lon),
                            displayName: data[0].display_name
                        };

                        // Center map on user location
                        map.setView([userLocation.lat, userLocation.lon], 10);

                        // Add user location marker
                        const userMarker = L.marker([userLocation.lat, userLocation.lon], {
                            icon: L.divIcon({
                                className: 'user-location-marker',
                                html: '<i class="fas fa-map-marker-alt" style="color: #3b82f6; font-size: 24px; text-shadow: 0 0 3px white;"></i>',
                                iconSize: [24, 24],
                                iconAnchor: [12, 24]
                            })
                        })
                        .addTo(map)
                        .bindPopup(`<b>Your Location</b><br>${userLocation.displayName || 'Searched location'}`);

                        markers.push(userMarker);

                        resolve(userLocation);
                    })
                    .catch(error => {
                        console.error("Geocoding failed:", error);
                        reject(error);
                    });
                });
        }

        // Modified function to handle errors in website URLs
        function normalizeData() {
            // Ensure all food bank entries have consistent format for items_needed
            let skipped = 0;
            
            for (const [name, data] of Object.entries(foodBankData)) {
                try {
                    // Convert string items to array if needed
                    if (data.items_needed) {
                        if (typeof data.items_needed === 'string') {
                            // Split by comma if it's a comma-separated string
                            data.items_needed = data.items_needed.split(',').map(item => item.trim());
                        } else if (!Array.isArray(data.items_needed)) {
                            // Convert to array with single item for any other type
                            data.items_needed = [String(data.items_needed)];
                        }
                    } else {
                        // Provide default if missing
                        data.items_needed = ['No specific items listed'];
                    }
                    
                    // Ensure latitude and longitude are properly formatted
                    if (data.latitude && typeof data.latitude === 'string') {
                        data.latitude = parseFloat(data.latitude);
                    }
                    
                    if (data.longitude && typeof data.longitude === 'string') {
                        data.longitude = parseFloat(data.longitude);
                    }
                    
                    // Add lat and lng for compatibility with recycling centers
                    data.lat = data.latitude;
                    data.lng = data.longitude;
                    
                    // Skip invalid entries
                    if (isNaN(data.latitude) || isNaN(data.longitude)) {
                        console.warn(`Skipping ${name} due to invalid coordinates`);
                        continue;
                    }
                    
                    // Ensure other required fields
                    if (!data.address) data.address = 'Address not available';
                    if (!data.location_type) data.location_type = 'Food Bank';
                    
                    // Ensure website is properly formatted - fix escaped slashes
                    if (data.website && typeof data.website === 'string') {
                        // Fix escaped slashes in URLs - replace all instances of \/ with /
                        data.website = data.website.replace(/\\\//g, '/');
                    }
                    
                    // Add name property for consistency with recycling centers
                    data.name = name;
                } catch (e) {
                    console.warn(`Error normalizing data for ${name}:`, e);
                    skipped++;
                }
            }
            
            if (skipped > 0) {
                console.warn(`Skipped normalizing ${skipped} entries due to errors`);
            }
        }

        function findRecyclingCenters() {
            const zip = document.getElementById("zipCode").value.trim();
            if (!zip) {
                document.getElementById("results").innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Please enter a location to search.</span>
                    </div>
                    <div class="no-results">
                        <i class="fas fa-map-marked-alt"></i>
                        <p>Enter a location above to find food banks and recycling centers near you.</p>
                    </div>
                `;
                return;
            }

            // Clear previous results
            document.getElementById("results").innerHTML = '<div class="loader"><i class="fas fa-spinner"></i><span>Searching...</span></div>';
            
            // Clear existing markers
            clearMarkers();
            
            // Reset previous findings
            foodBankLocationsFound = [];
            recyclingCentersFound = [];

            // Geocode the location
            geocodeLocation(zip)
                .then(userLocation => {
                    // Get the current filter type
                    currentSearchType = document.getElementById('locationType').value;
                    
                    // Find nearby food banks (if data is available and filter allows)
                    if (currentSearchType === 'all' || currentSearchType === 'food_bank') {
                        findFoodBanksNear(userLocation);
                    } else {
                        // If only showing recycling, display combined results anyway
                        displayCombinedResults();
                    }
                    
                    // Find nearby recycling centers (if filter allows)
                    if (currentSearchType === 'all' || currentSearchType === 'recycling') {
                        findRecyclingCentersNear(userLocation);
                    } else {
                        // If only showing food banks, display combined results anyway
                        displayCombinedResults();
                    }
                })
                .catch(error => {
                    console.error("Search error:", error);
                    document.getElementById("results").innerHTML = `
                        <div class="error-message">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>${error.message}</span>
                        </div>
                        <div class="no-results">
                            <i class="fas fa-map-marked-alt"></i>
                            <p>Try searching for a major city like "London" or "Manchester".</p>
                        <p>Make sure your internet connection is working properly.</p>
                        </div>
                    `;
                });
        }

        // Find food banks near a location
        function findFoodBanksNear(userLocation) {
            console.log("Searching for food banks near", userLocation);

            // Skip if food bank data is not loaded
            if (!foodBankData || Object.keys(foodBankData).length === 0) {
                console.warn("Food bank data not available");
                return;
            }

            const MAX_DISTANCE = 30; // km
            foodBankLocationsFound = [];

            // Loop through all food banks to find those within range
            for (const [name, data] of Object.entries(foodBankData)) {
                try {
                    if (!data.lat || !data.lng) continue;
                    
                    const distance = calculateDistance(
                        userLocation.lat, userLocation.lon,
                        data.lat, data.lng
                    );
                    
                    if (distance <= MAX_DISTANCE) {
                        foodBankLocationsFound.push({
                            ...data,
                            distance: distance,
                            type: 'food_bank'
                        });
                    }
                } catch (error) {
                    console.warn(`Error calculating distance for ${name}:`, error);
                }
            }

            // Sort by distance
            foodBankLocationsFound.sort((a, b) => a.distance - b.distance);
            
            // Add markers to the map
            addFoodBankMarkers(foodBankLocationsFound);
            
            console.log(`Found ${foodBankLocationsFound.length} food banks within ${MAX_DISTANCE}km`);
            
            // Display combined results (this will be called after recycling centers are found too)
            displayCombinedResults();
        }

        // Find recycling centers near a location using Overpass API
        function findRecyclingCentersNear(userLocation) {
            console.log("Searching for recycling centers near", userLocation);

            // Update status
            document.getElementById("recycling-status").innerHTML = '<i class="fas fa-spinner fa-spin"></i> Recycling Centers: Searching via Overpass API...';

            const radius = 10000; // 10km in meters
            recyclingCentersFound = [];

            // Build Overpass API query
            const overpassQuery = `
                [out:json];
                (
                  node["amenity"="recycling"](around:${radius},${userLocation.lat},${userLocation.lon});
                  way["amenity"="recycling"](around:${radius},${userLocation.lat},${userLocation.lon});
                  relation["amenity"="recycling"](around:${radius},${userLocation.lat},${userLocation.lon});
                  node["recycling_type"](around:${radius},${userLocation.lat},${userLocation.lon});
                  way["recycling_type"](around:${radius},${userLocation.lat},${userLocation.lon});
                  relation["recycling_type"](around:${radius},${userLocation.lat},${userLocation.lon});
                );
                out body;
                >;
                out skel qt;
            `;

            // Call Overpass API
            fetch("https://overpass-api.de/api/interpreter", {
                method: "POST",
                mode: 'cors',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Accept': 'application/json'
                },
                body: overpassQuery
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Overpass API request failed: " + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log("Recycling centers data received:", data);
                if (data && data.elements) {
                    // Process results
                    data.elements.forEach(element => {
                        if (element.type === "node" && element.tags && (element.tags.amenity === "recycling" || element.tags.recycling_type)) {
                            const name = element.tags.name ||
                                  (element.tags.recycling_type === "centre" ? "Recycling Centre" :
                                  (element.tags.recycling_type === "container" ? "Recycling Container" :
                                  "Recycling Point"));

                            const address = element.tags["addr:street"] ?
                                `${element.tags["addr:housenumber"] || ""} ${element.tags["addr:street"]}, ${element.tags["addr:city"] || ""}` :
                                (element.tags.address || element.tags.location || "Address not available");

                            const distance = calculateDistance(
                                userLocation.lat, userLocation.lon,
                                element.lat, element.lon
                            );

                            const materials = getRecyclingMaterials(element.tags);

                            recyclingCentersFound.push({
                                name: name,
                                lat: element.lat,
                                lng: element.lon,
                                distance: distance,
                                address: address,
                                operator: element.tags.operator,
                                recycling_type: element.tags.recycling_type,
                                materials: materials,
                                amenity: element.tags.amenity,
                                type: 'recycling'
                            });
                        }
                    });

                    // Sort by distance
                    recyclingCentersFound.sort((a, b) => a.distance - b.distance);

                    // Add markers to the map
                    addRecyclingMarkers(recyclingCentersFound);

                    console.log(`Found ${recyclingCentersFound.length} recycling points`);
                    
                    // Update status
                    document.getElementById("recycling-status").innerHTML = '<i class="fas fa-check" style="color: green;"></i> Recycling Centers: Found ' + recyclingCentersFound.length + ' locations';
                } else {
                    console.warn("No recycling center elements found in response:", data);
                }

                // Display combined results (even if we only have recycling centers)
                displayCombinedResults();
            })
            .catch(error => {
                console.error("Error fetching recycling centers:", error);
                // Create a few random recycling centers if the API fails
                if (recyclingCentersFound.length === 0) {
                    console.log("Creating some fallback recycling centers");
                    createFallbackRecyclingCenters(userLocation);
                    
                    // Update status
                    document.getElementById("recycling-status").innerHTML = '<i class="fas fa-exclamation-triangle" style="color: orange;"></i> Recycling Centers: Using fallback data (API failed)';
                } else {
                    // Update status
                    document.getElementById("recycling-status").innerHTML = '<i class="fas fa-exclamation-triangle" style="color: orange;"></i> Recycling Centers: API error, but found ' + recyclingCentersFound.length + ' locations';
                }
                // Still display combined results with whatever we have
                displayCombinedResults();
            });
        }

        // Create some fallback recycling centers in case the Overpass API fails
        function createFallbackRecyclingCenters(userLocation) {
            // Calculate points around the user location
            for (let i = 0; i < 5; i++) {
                // Random angle and distance
                const angle = Math.random() * 2 * Math.PI;
                const distance = 1 + Math.random() * 5; // 1-6km away
                
                // Calculate new coordinates (approximate)
                const lat_offset = distance * Math.cos(angle) / 111.32; // 1 degree lat = 111.32 km
                const lon_offset = distance * Math.sin(angle) / (111.32 * Math.cos(userLocation.lat * Math.PI/180)); // Adjust for latitude
                
                const recyclingCenter = {
                    name: `Recycling Center ${i+1}`,
                    lat: userLocation.lat + lat_offset,
                    lng: userLocation.lon + lon_offset,
                    distance: distance,
                    address: "Generated location",
                    recycling_type: ["centre", "container"][Math.floor(Math.random() * 2)],
                    materials: ["plastic", "paper", "glass", "metal", "electronics"].slice(0, Math.floor(Math.random() * 5) + 1),
                    type: 'recycling'
                };
                
                recyclingCentersFound.push(recyclingCenter);
            }
            
            // Add markers to the map
            addRecyclingMarkers(recyclingCentersFound);
        }

        // Add food bank markers to the map
        function addFoodBankMarkers(locations) {
            // Skip if we're only showing recycling centers
            if (currentSearchType === 'recycling') return;
            
            locations.forEach(location => {
                const marker = L.marker([location.lat, location.lng], {
                    icon: L.divIcon({
                        className: 'food-bank-marker',
                        html: '<i class="fas fa-shopping-basket" style="color: #fb923c; font-size: 24px;"></i>',
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    })
                });

                // Create popup content
                const popupContent = `
                    <div class="popup-content">
                        <h3>${location.name}</h3>
                        <p><strong>Distance:</strong> ${location.distance.toFixed(1)} km</p>
                        <p><strong>Address:</strong> ${location.address}</p>
                        ${location.website ? `<p><strong>Website:</strong> <a href="${location.website}" target="_blank">${location.website}</a></p>` : ''}
                        ${location.phone ? `<p><strong>Phone:</strong> ${location.phone}</p>` : ''}
                        ${location.email ? `<p><strong>Email:</strong> ${location.email}</p>` : ''}
                        ${location.items_needed && location.items_needed.length > 0 ?
                            `<p><strong>Items Needed:</strong> ${location.items_needed.slice(0, 5).join(', ')}${location.items_needed.length > 5 ? '...' : ''}</p>` : ''}
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                markerCluster.addLayer(marker);
                markers.push(marker);
            });
        }

        // Add recycling center markers to the map
        function addRecyclingMarkers(locations) {
            // Skip if we're only showing food banks
            if (currentSearchType === 'food_bank') return;
            
            locations.forEach(location => {
                const marker = L.marker([location.lat, location.lng], {
                    icon: L.divIcon({
                        className: 'recycling-marker',
                        html: '<i class="fas fa-recycle" style="color: #22c55e; font-size: 24px;"></i>',
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    })
                });
                
                // Create popup content
                const popupContent = `
                    <div class="popup-content">
                        <h3>${location.name}</h3>
                        <p><strong>Distance:</strong> ${location.distance.toFixed(1)} km</p>
                        <p><strong>Address:</strong> ${location.address}</p>
                        ${location.operator ? `<p><strong>Operator:</strong> ${location.operator}</p>` : ''}
                        ${location.recycling_type ? `<p><strong>Type:</strong> ${location.recycling_type}</p>` : ''}
                        ${location.materials && location.materials.length > 0 ?
                            `<p><strong>Materials:</strong> ${location.materials.join(', ')}</p>` : ''}
                    </div>
                `;

                marker.bindPopup(popupContent);
                markerCluster.addLayer(marker);
                markers.push(marker);
            });
        }

        // Display combined results from both food banks and recycling centers
        function displayCombinedResults() {
            const resultsContainer = document.getElementById('results');
            let paginationContainer = null;

            // Get all locations based on filter
            let allLocations = [];
            if (currentSearchType === 'all') {
                allLocations = [...foodBankLocationsFound, ...recyclingCentersFound];
            } else if (currentSearchType === 'food_bank') {
                allLocations = [...foodBankLocationsFound];
            } else if (currentSearchType === 'recycling') {
                allLocations = [...recyclingCentersFound];
            }
            
            // Sort by distance
            allLocations.sort((a, b) => a.distance - b.distance);
            
            // Store the currently displayed locations
            displayedLocations = allLocations;

            // If we have no results yet, don't display an error
            if (allLocations.length === 0 && resultsContainer.querySelector('.loader')) {
                // Still loading or no results found
                return;
            }

            // Check if we have results
            if (allLocations.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-search"></i>
                        <p>No ${currentSearchType === 'all' ? 'locations' : 
                           currentSearchType === 'food_bank' ? 'food banks' : 'recycling centers'} 
                           found nearby. Try increasing your search radius or searching in a different location.</p>
                    </div>`;
                return;
            }

            // Create results header
            resultsContainer.innerHTML = '';
            const resultsHeader = document.createElement('h2');
            resultsHeader.innerHTML = `<i class="fas fa-list-ul"></i> ${allLocations.length} locations found`;
            resultsContainer.appendChild(resultsHeader);

            // Create results list container
            const resultsListContainer = document.createElement('div');
            resultsListContainer.className = 'results-list';
            resultsContainer.appendChild(resultsListContainer);

            // Setup pagination
            const resultsPerPage = 20;
            const totalPages = Math.ceil(allLocations.length / resultsPerPage);
            let currentPage = 1;

            // Function to display a specific page
            function displayPage(page) {
                // Clear previous results
                resultsListContainer.innerHTML = '';
                
                // Calculate start and end indices
                const startIndex = (page - 1) * resultsPerPage;
                const endIndex = Math.min(startIndex + resultsPerPage, allLocations.length);

                // Display locations for current page
                for (let i = startIndex; i < endIndex; i++) {
                    const location = allLocations[i];
                    const locationElement = document.createElement('div');
                    locationElement.className = 'location-item';
                    locationElement.dataset.id = i; // Store index for later reference
                    
                    // Add specific CSS class based on location type
                    if (location.type === 'recycling') {
                        locationElement.style.borderLeftColor = 'var(--recycling)';
                    } else {
                        locationElement.style.borderLeftColor = 'var(--food-bank)';
                    }

                    if (location.type === 'food_bank') {
                        locationElement.innerHTML = `
                            <h3><i class="fas fa-shopping-basket food-bank-icon"></i> ${location.name} <span class="location-type type-food-bank">Food Bank</span></h3>
                            <p class="location-distance"><i class="fas fa-location-arrow"></i> ${location.distance.toFixed(1)} km</p>
                            <p class="location-address"><i class="fas fa-map-marker-alt"></i> ${location.address || 'Address not available'}</p>
                        `;
                        
                        // Add expandable content that will show when clicked
                        if (location.items_needed && location.items_needed.length > 0 || 
                            location.website || location.phone || location.email) {
                            
                            const expandableContent = document.createElement('div');
                            expandableContent.className = 'expandable-content';
                            expandableContent.style.display = 'none';
                            
                            let expandableHTML = '';
                            
                            if (location.website) {
                                expandableHTML += `<p><i class="fas fa-globe"></i> <a href="${location.website}" target="_blank">Website</a></p>`;
                            }
                            
                            if (location.phone) {
                                expandableHTML += `<p><i class="fas fa-phone"></i> ${location.phone}</p>`;
                            }
                            
                            if (location.email) {
                                expandableHTML += `<p><i class="fas fa-envelope"></i> ${location.email}</p>`;
                            }
                            
                            if (location.items_needed && location.items_needed.length > 0) {
                                expandableHTML += `
                                <div style="margin-top: 0.5rem;">
                                    <p><strong>Items Needed:</strong></p>
                        <ul class="items-list">
                                        ${location.items_needed.slice(0, 5).map(item => `<li>${item}</li>`).join('')}
                                        ${location.items_needed.length > 5 ? 
                                            `<li><i>...and ${location.items_needed.length - 5} more items</i></li>` : ''}
                        </ul>
                                </div>`;
                            }
                            
                            expandableContent.innerHTML = expandableHTML;
                            locationElement.appendChild(expandableContent);
                            
                            // Add "More" button if we have expandable content
                            if (expandableHTML) {
                                const moreBtn = document.createElement('button');
                                moreBtn.className = 'more-btn';
                                moreBtn.innerHTML = '<i class="fas fa-chevron-down"></i> More info';
                                
                                moreBtn.addEventListener('click', function(e) {
                                    e.stopPropagation(); // Prevent triggering the parent click
                                    
                                    const content = this.parentNode.querySelector('.expandable-content');
                                    if (content.style.display === 'none') {
                                        content.style.display = 'block';
                                        this.innerHTML = '<i class="fas fa-chevron-up"></i> Less info';
                                    } else {
                                        content.style.display = 'none';
                                        this.innerHTML = '<i class="fas fa-chevron-down"></i> More info';
                                    }
                                });
                                
                                locationElement.appendChild(moreBtn);
                            }
                        }
                    } else {
                        locationElement.innerHTML = `
                            <h3><i class="fas fa-recycle recycling-icon"></i> ${location.name} <span class="location-type type-recycling">Recycling</span></h3>
                            <p class="location-distance"><i class="fas fa-location-arrow"></i> ${location.distance.toFixed(1)} km</p>
                            <p class="location-address"><i class="fas fa-map-marker-alt"></i> ${location.address || 'Address not available'}</p>
                        `;
                        
                        // Add expandable content for recycling centers too
                        if (location.materials && location.materials.length > 0 || 
                            location.operator || location.recycling_type || location.amenity) {
                            
                            const expandableContent = document.createElement('div');
                            expandableContent.className = 'expandable-content';
                            expandableContent.style.display = 'none';
                            
                            let expandableHTML = '';
                            
                            if (location.operator) {
                                expandableHTML += `<p><i class="fas fa-user"></i> Operated by: ${location.operator}</p>`;
                            }
                            
                            if (location.recycling_type) {
                                expandableHTML += `<p><i class="fas fa-info-circle"></i> Type: ${location.recycling_type}</p>`;
                            }
                            
                            if (location.materials && location.materials.length > 0) {
                                expandableHTML += `
                                <div style="margin-top: 0.5rem;">
                                    <p><strong>Materials Accepted:</strong></p>
                                    <ul class="items-list">
                                        ${location.materials.slice(0, 5).map(item => `<li>${item}</li>`).join('')}
                                        ${location.materials.length > 5 ? 
                                            `<li><i>...and ${location.materials.length - 5} more materials</i></li>` : ''}
                                    </ul>
                                </div>`;
                            }
                            
                            expandableContent.innerHTML = expandableHTML;
                            locationElement.appendChild(expandableContent);
                            
                            // Add "More" button if we have expandable content
                            if (expandableHTML) {
                                const moreBtn = document.createElement('button');
                                moreBtn.className = 'more-btn';
                                moreBtn.innerHTML = '<i class="fas fa-chevron-down"></i> More info';
                                
                                moreBtn.addEventListener('click', function(e) {
                                    e.stopPropagation(); // Prevent triggering the parent click
                                    
                                    const content = this.parentNode.querySelector('.expandable-content');
                                    if (content.style.display === 'none') {
                                        content.style.display = 'block';
                                        this.innerHTML = '<i class="fas fa-chevron-up"></i> Less info';
                                    } else {
                                        content.style.display = 'none';
                                        this.innerHTML = '<i class="fas fa-chevron-down"></i> More info';
                                    }
                                });
                                
                                locationElement.appendChild(moreBtn);
                            }
                        }
                    }

                    // Add click event to center map on location
                    locationElement.addEventListener('click', function() {
                        // Center map
                        map.setView([location.lat, location.lng], 14);
                        
                        // Find and open the marker popup for this location
                        markerCluster.eachLayer(marker => {
                            const markerLatLng = marker.getLatLng();
                            if (Math.abs(markerLatLng.lat - location.lat) < 0.0001 && 
                                Math.abs(markerLatLng.lng - location.lng) < 0.0001) {
                                marker.openPopup();
                            }
                        });
                        
                        // Highlight this item
                        document.querySelectorAll('.location-item').forEach(item => {
                            item.classList.remove('active');
                        });
                        
                        this.classList.add('active');
                        
                        // On mobile, collapse the sidebar
                        if (window.innerWidth <= 768) {
                            document.querySelector('.sidebar').classList.remove('expanded');
                        }
                    });

                    resultsListContainer.appendChild(locationElement);
                }

                // Update current page
                currentPage = page;
                
                // Update pagination display
                if (paginationContainer) {
                    paginationContainer.querySelector('.current-page').textContent = `${currentPage}/${totalPages}`;
                    paginationContainer.querySelector('.prev-page').disabled = currentPage === 1;
                    paginationContainer.querySelector('.next-page').disabled = currentPage === totalPages;
                }
            }

            // Create pagination controls if needed
            if (totalPages > 1) {
                paginationContainer = document.createElement('div');
                paginationContainer.className = 'pagination';
                
                paginationContainer.innerHTML = `
                    <button class="prev-page" ${currentPage === 1 ? 'disabled' : ''}><i class="fas fa-chevron-left"></i></button>
                    <span class="current-page">1/${totalPages}</span>
                    <button class="next-page" ${currentPage === totalPages ? 'disabled' : ''}><i class="fas fa-chevron-right"></i></button>
                `;

                // Add event listeners for pagination
                paginationContainer.querySelector('.prev-page').addEventListener('click', () => {
                    if (currentPage > 1) {
                        displayPage(currentPage - 1);
                    }
                });

                paginationContainer.querySelector('.next-page').addEventListener('click', () => {
                    if (currentPage < totalPages) {
                        displayPage(currentPage + 1);
                    }
                });

                resultsContainer.appendChild(paginationContainer);
            }

            // Display first page
            displayPage(1);
            
            // Add mobile toggle functionality
            if (window.innerWidth <= 768) {
                // Show the sidebar in expanded mode when results are found
                document.querySelector('.sidebar').classList.add('expanded');
                
                // When a location is clicked, collapse the sidebar
                document.querySelectorAll('.location-item').forEach(item => {
                    item.addEventListener('click', () => {
                        document.querySelector('.sidebar').classList.remove('expanded');
                    });
                });
            }
        }

        function centerMapOn(lat, lon, name) {
            map.setView([lat, lon], 14);
            
            // Find and open the marker popup for this location
            markerCluster.eachLayer(marker => {
                const markerLatLng = marker.getLatLng();
                if (Math.abs(markerLatLng.lat - lat) < 0.0001 && 
                    Math.abs(markerLatLng.lng - lon) < 0.0001) {
                    marker.openPopup();
                }
            });
        }

        function deg2rad(deg) {
            return deg * (Math.PI/180);
        }

        function filterResults() {
            const selectedType = document.getElementById('locationType').value;
            currentSearchType = selectedType;
            
            // Clear existing markers
            clearMarkers();
            
            // Redisplay the appropriate markers
            if (currentSearchType === 'all' || currentSearchType === 'food_bank') {
                addFoodBankMarkers(foodBankLocationsFound);
            }
            
            if (currentSearchType === 'all' || currentSearchType === 'recycling') {
                addRecyclingMarkers(recyclingCentersFound);
            }
            
            // Update the results list
            displayCombinedResults();
        }
    </script>

    <!-- Initialize kaleidoscope effect -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof TlgKaleidoscope !== 'undefined') {
                // Initialize kaleidoscope after the page has loaded
                TlgKaleidoscope.init();

                // Add some interaction - change kaleidoscope properties on scroll
                window.addEventListener('scroll', function() {
                    const scrollPosition = window.scrollY;
                    const kaleidoscopeElem = document.querySelector('[tlg-kaleidoscope-canvas]');

                    if (kaleidoscopeElem && scrollPosition < 500) {
                        // Adjust opacity based on scroll position
                        const opacity = Math.max(0, 0.65 - (scrollPosition / 500));
                        kaleidoscopeElem.style.opacity = opacity;

                        // Also adjust rotation speed
                        const motionValue = Math.max(0.2, 1.2 - (scrollPosition / 500));
                        kaleidoscopeElem.setAttribute('tlg-kaleidoscope-motion', motionValue);
                    }
                });
            } else {
                console.warn('TlgKaleidoscope not loaded');
            }
        });
    </script>

    <!-- Mobile toggle button for sidebar -->
    <div class="mobile-toggle" id="mobileToggle">
        <i class="fas fa-list"></i>
        <span class="toggle-tooltip">Toggle Results</span>
    </div>

    <script>
        // Mobile sidebar toggle
        document.addEventListener('DOMContentLoaded', function() {
            const mobileToggle = document.getElementById('mobileToggle');
            const sidebar = document.querySelector('.sidebar');
            
            if (mobileToggle && sidebar) {
                mobileToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('expanded');
                    
                    // Update icon
                    const icon = this.querySelector('i');
                    if (sidebar.classList.contains('expanded')) {
                        icon.className = 'fas fa-times';
                    } else {
                        icon.className = 'fas fa-list';
                    }
                });
            }
            
            // Adjust layout on resize
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    sidebar.classList.remove('expanded');
                    if (mobileToggle) {
                        mobileToggle.querySelector('i').className = 'fas fa-list';
                    }
                }
            });
        });
    </script>
</body>
</html>